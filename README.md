# Классификация отзывов с маркетплейса

## Задача
Автоматически классифицировать отзывы покупателей по категориям товаров.  
Целевая метрика — **Weighted F1** (включая класс «нет товара»). Лимит на инференс — **≤ 5 сек/пример**.

**Классы:**
бытовая техника, обувь, одежда, посуда, текстиль, товары для детей, украшения и аксессуары, электроника, нет товара

---

## Данные и ограничения
- `train.csv` — изначально **без меток** (используется для авторазметки и обучения)
- `test.csv` — для финального предсказания
- `categories.txt` — список целевых категорий

**Ограничения соревнования:**
- Без внешних API (ChatGPT/DeepSeek и т.п.)
- Без внешних датасетов (разрешена аугментация на базе выданных данных)
- Ресурсы — Google Colab (GPU T4, 16 GB VRAM)
- Инференс: ≤ 5 сек/пример (в среднем)

---

## Подход и этапы решения

### 1) Авторазметка (pseudo-labeling)
- База: XLM-RoBERTa (zero-shot старт для первичных меток)
- Промпт-подсказки для лучшего разделения близких классов
- Очистка и балансировка классов после первичной разметки  

### 2) Дообучение модели (fine-tuning)
- Архитектура: **XLM-RoBERTa**
- Режимы: обучение только головы классификатора и полное дообучение
- Борьба с дисбалансом: **class weights**
- Лоссы: CrossEntropy и **Focal Loss**  
*Итог:* дообучение на псевдоразметке дало прирост Weighted F1.

### 3) Варианты лосс-функций и стабилизация
- CE как базовый, **Focal Loss** для редких классов
- Рандомные сиды, ранняя остановка, выбор лучшей модели по валидации  
*Итог:* Focal + веса классов показали баланс по всем классам.

### 4) Финальный инференс
- Загрузка лучшей контрольной точки
- Пакетная обработка `test.csv`
- Сохранение предсказаний в `submission.csv` (формат см. ниже)
- Контроль скорости (батчинг, отключение лишних локс/логов)  
*Итог:* укладываемся в лимит по времени и ресурсам Colab.

---

## Результаты
- Валидация: **Weighted F1 ≈ 0.73**
- Ограничения по ресурсам и скорости
- Финальный артефакт: `submission.csv`

---

## Структура репозитория

```
├── train.csv                 # обучающие отзывы (без меток)
├── test.csv                  # тестовые отзывы
├── categories.txt            # список категорий
├── main.ipynb                # ноутбук с полным пайплайном
├── fine_tune_xlmr_pseudo.py  # скрипт авторазметки и/или дообучения
├── infer_and_eval.py         # инференс и подсчёт метрик
├── outputs_*                 # результаты экспериментов/чекпойнты/логи
└── submission_example.csv    # пример сабмита
```


# Установка окружения и зависимостей
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

# Авторазметка и/или обучение
python fine_tune_xlmr_pseudo.py \
  --train_path train.csv \
  --categories_path categories.txt \
  --output_dir outputs_xlmr_headonly_focal \
  --epochs 3 --batch_size 16 --lr 2e-5 \
  --use_focal --class_weights


# Инференс и метрики (валидация/тест)
python infer_and_eval.py \
  --model_dir outputs_xlmr_headonly_focal \
  --test_path test.csv \
  --categories_path categories.txt \
  --submission_path submission.csv
